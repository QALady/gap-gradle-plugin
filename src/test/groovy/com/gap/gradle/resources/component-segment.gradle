segment {
    prepare {
        build_war {
            action 'WM Exec:Run'
            parameters {
                cmd {
                    value './gradlew war'
                }
            }
        }
    }
    test {
        unit_test {
            action 'WM Exec:Run'
            parameters {
                cmd {
                    value './gradlew test'
                }
            }
        }
    }
    approve {
        '0_sonar' {
            action 'WM Exec:Run'
            parameters {
                cmd {
                    value './gradlew sonar -Pversion=$[/myJob/version]'
                }
            }
        }
        '1_createLink' {
            action 'EC-FileOps:Remote Copy - Native'
            workspaceName 'chefLocalAgents'
            runOrder 'parallel'
            runCondition 'always'
            parameters {
                'Link Label' {
                    value 'domain-a Junit Results'
                }
                'Source Resource' {
                    value '$[/myJobStep/resourceName]'
                }
                'Source Workspace' {
                    value 'chefLocalAgents'
                }
                'Source Path' {
                    value '$[/myJob/watchmen_config/workingDir]/app-a/domain-a/build/reports/tests'
                }
                'Destination Resource' {
                    value 'local'
                }
                'Destination Workspace' {
                    value 'nfs'
                }
                'Destination Path' {
                    value '$[/server/watchmen_config/sharedHtdocs]/reports/$[jobId]_domain_a'
                }
            }
        }
        '2_createLink' {
            action 'EC-FileOps:Remote Copy - Native'
            workspaceName 'chefLocalAgents'
            runOrder 'parallel'
            runCondition 'always'
            parameters {
                'Link Label' {
                    value 'app-a Junit Results'
                }
                'Source Resource' {
                    value '$[/myJobStep/resourceName]'
                }
                'Source Workspace' {
                    value 'chefLocalAgents'
                }
                'Source Path' {
                    value '$[/myJob/watchmen_config/workingDir]/app-a/webapp-a/build/reports/tests'
                }
                'Destination Resource' {
                    value 'local'
                }
                'Destination Workspace' {
                    value 'nfs'
                }
                'Destination Path' {
                    value '$[/server/watchmen_config/sharedHtdocs]/reports/$[jobId]_app_a'
                }
            }
        }
        '3_createLink' {
            action 'EC-FileOps:Remote Copy - Native'
            workspaceName 'chefLocalAgents'
            runOrder 'parallel'
            runCondition 'always'
            parameters {
                'Link Label' {
                    value 'domain-b Junit Results'
                }
                'Source Resource' {
                    value '$[/myJobStep/resourceName]'
                }
                'Source Workspace' {
                    value 'chefLocalAgents'
                }
                'Source Path' {
                    value '$[/myJob/watchmen_config/workingDir]/app-b/domain-b/build/reports/tests'
                }
                'Destination Resource' {
                    value 'local'
                }
                'Destination Workspace' {
                    value 'nfs'
                }
                'Destination Path' {
                    value '$[/server/watchmen_config/sharedHtdocs]/reports/$[jobId]_domain_b'
                }
            }
        }
        '4_createLink' {
            action 'EC-FileOps:Remote Copy - Native'
            workspaceName 'chefLocalAgents'
            runOrder 'parallel'
            runCondition 'always'
            parameters {
                'Link Label' {
                    value 'app-b Junit Results'
                }
                'Source Resource' {
                    value '$[/myJobStep/resourceName]'
                }
                'Source Workspace' {
                    value 'chefLocalAgents'
                }
                'Source Path' {
                    value '$[/myJob/watchmen_config/workingDir]/app-b/webapp-b/build/reports/tests'
                }
                'Destination Resource' {
                    value 'local'
                }
                'Destination Workspace' {
                    value 'nfs'
                }
                'Destination Path' {
                    value '$[/server/watchmen_config/sharedHtdocs]/reports/$[jobId]_app_b'
                }
            }
        }
        '5_publish' {
            action 'WM Exec:Run'
            parameters {
                cmd {
                    value './gradlew packageRpm -Pversion=$[/myJob/version]'
                }
            }
        }
        '6_publish' {
            action 'WM Publish:RPM'
            parameters {
                channel {
                    value 'devel'
                }
                repoName {
                    value 'watchmen'
                }
                sourcePath {
                    value 'build/distributions/ref-app-$[/myJob/version]-1.noarch.rpm'
                }
            }
        }
        upload_archives {
            action 'WM Exec:Run'
            parameters {
                cmd {
                    value './gradlew uploadArchives -Pversion=$[/myJob/version]'
                }
            }
        }
    }
    jobLinks {
        'domain-a Junit Results' {
            link '/reports/$[jobId]_domain_a'
        }
        'app-a Junit Results' {
            link '/reports/$[jobId]_app_a'
        }
        'domain-b Junit Results' {
            link '/reports/$[jobId]_domain_b'
        }
        'app-b Junit Results' {
            link '/reports/$[jobId]_app_b'
        }
    }
    _finally {
        '0_final' {
            action 'test_final'
        }
    }
}